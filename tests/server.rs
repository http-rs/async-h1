use async_std::io::Cursor;
use async_std::prelude::*;
use common::TestCase;
use http_types::{mime, Body, Response, StatusCode};

mod common;

#[async_std::test]
async fn test_basic_request() {
    let case = TestCase::new_server("fixtures/request1.txt", "fixtures/response1.txt").await;
    let addr = "http://example.com";

    async_h1::accept(addr, case.clone(), |_req| async {
        let mut resp = Response::new(StatusCode::Ok);
        resp.set_body("");
        Ok(resp)
    })
    .await
    .unwrap();

    case.assert().await;
}

#[async_std::test]
async fn test_chunked_basic() {
    let case = TestCase::new_server(
        "fixtures/request-chunked-basic.txt",
        "fixtures/response-chunked-basic.txt",
    )
    .await;
    let addr = "http://example.com";

    async_h1::accept(addr, case.clone(), |_req| async {
        let mut resp = Response::new(StatusCode::Ok);
        resp.set_body(Body::from_reader(
            Cursor::new(b"Mozilla")
                .chain(Cursor::new(b"Developer"))
                .chain(Cursor::new(b"Network")),
            None,
        ));
        resp.set_content_type(mime::PLAIN);
        Ok(resp)
    })
    .await
    .unwrap();

    case.assert().await;
}

#[async_std::test]
async fn test_chunked_echo() {
    let case = TestCase::new_server(
        "fixtures/request-chunked-echo.txt",
        "fixtures/response-chunked-echo.txt",
    )
    .await;
    let addr = "http://example.com";

    async_h1::accept(addr, case.clone(), |req| async {
        let mut resp = Response::new(StatusCode::Ok);
        let ct = req.content_type();
        let body: Body = req.into();
        resp.set_body(body);
        if let Some(ct) = ct {
            resp.set_content_type(ct);
        }

        Ok(resp)
    })
    .await
    .unwrap();

    case.assert().await;
}

#[async_std::test]
async fn large_file() {
    let case = TestCase::new_server("fixtures/large.txt", "fixtures/large.txt").await;
    let addr = "http://example.com";

    async_h1::accept(addr, case.clone(), |req| async {
        let mut res = Response::new(StatusCode::Ok);
        res.set_body(req);
        Ok(res)
    })
    .await
    .unwrap();

    case.assert().await;
}
